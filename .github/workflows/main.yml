name: Continuous Integration
on: [push, pull_request]

jobs:
  jest:
    name: functional tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set Node.js 16.x
      uses: actions/setup-node@master
      with:
        node-version: 16.x

    - name: install dependencies
      run: npm ci

    - name: run jest tests
      run: npm test

  integration_test_setup:
    runs-on: ubuntu-latest
    name: install pyenv
    steps:

    # #  _____   ____
    # # | ____| / ___|
    # # |  _|  | |  _
    # # | |___ | |_| |_
    # # |_____(_)____(_)
    # - name: save state
    #   run: echo "{name}={value}" >> $GITHUB_STATE

    # - name: set output
    #   run: echo "{name}={value}" >> $GITHUB_OUTPUT

    - name: extract branch name
      id: extract_branch
      run: echo "branch=$(echo ${GITHUB_HEAD_REF}) >> $GITHUB_OUTPUT"
      shell: bash

    - name: setup pyenv
      id: pyenv
      # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#example-using-output-as-url
      uses: "gabrielfalcao/pyenv-action@${{ steps.extract_branch.outputs.branch }}"

    - name: List python versions
      run: pyenv versions

    - name: Verify default installation
      run: python --version

    - name: list files in pyenv_root
      run: ls -lhtr ${{ steps.pyenv.outputs.pyenv_root }}

  integration_test_preinstall_default:
    runs-on: ubuntu-latest
    name: pre-install default version
    steps:
    - name: pyenv + python 3.7.16
      id: pyenv
      uses: "gabrielfalcao/pyenv-action@main"
      with:
        default: 3.7.16

    - name: pyenv + python 3.7.16 cached
      id: pyenv2
      uses: "gabrielfalcao/pyenv-action@main"
      with:
        default: 3.7.16

    - name: List python versions
      run: pyenv versions

    - name: Verify default installation
      run: python --version | grep 3.7.16

  integration_test_preinstall_versions:
    runs-on: ubuntu-latest
    name: pre-install multiple versions of python
    steps:
    - name: pyenv + python 3.6.15 and 3.7.16
      id: pyenv
      uses: "gabrielfalcao/pyenv-action@main"
      with:
        default: 3.7.16
        command: |
          pip install -U pip
          pip install -U setuptools

        versions: 3.6.15,

    - name: List python versions
      run: pyenv versions

    - name: Verify default installation
      run: python --version

    - name: Verify python 3.6.15 installation
      run: pyenv local 3.6.15 && python --version | grep 3.6.15

    - name: Verify python 3.7.16 installation
      run: pyenv local 3.7.16 && python --version | grep 3.7.16


  integration_test_run_command_after_each_installation:
    runs-on: ubuntu-latest
    name: run command after installing each python version
    steps:
    - name: Python 3.6.15 and 3.7.16 with latest pip
      id: pyenv
      uses: "gabrielfalcao/pyenv-action@main"
      with:
        default: 3.7.16
        command: |
          pip install -U pip
          pip install -U setuptools

        versions: 3.6.15,

    - name: List python versions
      run: pyenv versions

    - name: Verify default installation
      run: python --version

    - name: Verify pip version on python 3.6.15 installation
      run: pyenv local 3.6.15 && pip --version

    - name: Verify pip version on python 3.7.16 installation
      run: pyenv local 3.7.16 && pip --version
